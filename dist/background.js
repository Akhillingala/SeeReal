/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";var e,t,n;!function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"}(e||(e={})),function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"}(t||(t={})),function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"}(n||(n={}));const s=["user","model","function","system"];var a,o,i,r,c,l,d,u,h;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"}(a||(a={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(o||(o={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(i||(i={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(r||(r={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.OTHER="OTHER"}(c||(c={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(l||(l={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(d||(d={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"}(u||(u={}));class g extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class f extends g{constructor(e,t){super(e),this.response=t}}class p extends g{constructor(e,t,n,s){super(e),this.status=t,this.statusText=n,this.errorDetails=s}}class m extends g{}!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(h||(h={}));class y{constructor(e,t,n,s,a){this.model=e,this.task=t,this.apiKey=n,this.stream=s,this.requestOptions=a}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let s=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(s+="?alt=sse"),s}}async function E(e){var t;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.21.0"),t.join(" ")}(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let s=null===(t=e.requestOptions)||void 0===t?void 0:t.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(e){throw new m(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${e.message}`)}for(const[e,t]of s.entries()){if("x-goog-api-key"===e)throw new m(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new m(`Header name ${e} can only be set using the apiClient field`);n.append(e,t)}}return n}async function b(e,t,n,s,a,o={},i=fetch){const{url:r,fetchOptions:c}=await async function(e,t,n,s,a,o){const i=new y(e,t,n,s,o);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},C(o)),{method:"POST",headers:await E(i),body:a})}}(e,t,n,s,a,o);return async function(e,t,n=fetch){let s;try{s=await n(e,t)}catch(t){!function(e,t){let n=e;throw e instanceof p||e instanceof m||(n=new g(`Error fetching from ${t.toString()}: ${e.message}`),n.stack=e.stack),n}(t,e)}return s.ok||await async function(e,t){let n,s="";try{const t=await e.json();s=t.error.message,t.error.details&&(s+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new p(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${s}`,e.status,e.statusText,n)}(s,e),s}(r,c,i)}function C(e){const t={};if(void 0!==(null==e?void 0:e.signal)||(null==e?void 0:e.timeout)>=0){const n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}function A(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),O(e.candidates[0]))throw new f(`${v(e)}`,e);return function(e){var t,n,s,a;const o=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(s=e.candidates)||void 0===s?void 0:s[0].content)||void 0===a?void 0:a.parts)t.text&&o.push(t.text),t.executableCode&&o.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&o.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return o.length>0?o.join(""):""}(e)}if(e.promptFeedback)throw new f(`Text not available. ${v(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),O(e.candidates[0]))throw new f(`${v(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),w(e)[0]}if(e.promptFeedback)throw new f(`Function call not available. ${v(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),O(e.candidates[0]))throw new f(`${v(e)}`,e);return w(e)}if(e.promptFeedback)throw new f(`Function call not available. ${v(e)}`,e)},e}function w(e){var t,n,s,a;const o=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(a=null===(s=e.candidates)||void 0===s?void 0:s[0].content)||void 0===a?void 0:a.parts)t.functionCall&&o.push(t.functionCall);return o.length>0?o:void 0}const S=[c.RECITATION,c.SAFETY,c.LANGUAGE];function O(e){return!!e.finishReason&&S.includes(e.finishReason)}function v(e){var t,n,s;let a="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(s=e.candidates)||void 0===s?void 0:s[0]){const t=e.candidates[0];O(t)&&(a+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(a+=`: ${t.finishMessage}`))}}else a+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(a+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(a+=`: ${e.promptFeedback.blockReasonMessage}`);return a}function _(e){return this instanceof _?(this.v=e,this):new _(e)}"function"==typeof SuppressedError&&SuppressedError;const R=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function I(e){const t=[],n=e.getReader();for(;;){const{done:e,value:s}=await n.read();if(e)return A(N(t));t.push(s)}}function T(e){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,a=n.apply(e,t||[]),o=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){a[e]&&(s[e]=function(t){return new Promise(function(n,s){o.push([e,t,n,s])>1||r(e,t)})})}function r(e,t){try{(n=a[e](t)).value instanceof _?Promise.resolve(n.value.v).then(c,l):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function c(e){r("next",e)}function l(e){r("throw",e)}function d(e,t){e(t),o.shift(),o.length&&r(o[0][0],o[0][1])}}(this,arguments,function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield _(t.read());if(n)break;yield yield _(A(e))}})}function N(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e){if(t.candidates)for(const e of t.candidates){const t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].groundingMetadata=e.groundingMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});const s={};for(const a of e.content.parts)a.text&&(s.text=a.text),a.functionCall&&(s.functionCall=a.functionCall),a.executableCode&&(s.executableCode=a.executableCode),a.codeExecutionResult&&(s.codeExecutionResult=a.codeExecutionResult),0===Object.keys(s).length&&(s.text=""),n.candidates[t].content.parts.push(s)}}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}async function D(e,t,n,s){return function(e){const t=function(e){const t=e.getReader();return new ReadableStream({start(e){let n="";return function s(){return t.read().then(({value:t,done:a})=>{if(a)return n.trim()?void e.error(new g("Failed to parse stream")):void e.close();n+=t;let o,i=n.match(R);for(;i;){try{o=JSON.parse(i[1])}catch(t){return void e.error(new g(`Error parsing JSON response: "${i[1]}"`))}e.enqueue(o),n=n.substring(i[0].length),i=n.match(R)}return s()})}()}})}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,s]=t.tee();return{stream:T(n),response:I(s)}}(await b(t,h.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),s))}async function M(e,t,n,s){const a=await b(t,h.GENERATE_CONTENT,e,!1,JSON.stringify(n),s);return{response:A(await a.json())}}function x(e){if(null!=e)return"string"==typeof e?{role:"system",parts:[{text:e}]}:e.text?{role:"system",parts:[e]}:e.parts?e.role?e:{role:"system",parts:e.parts}:void 0}function H(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let s=!1,a=!1;for(const o of e)"functionResponse"in o?(n.parts.push(o),a=!0):(t.parts.push(o),s=!0);if(s&&a)throw new g("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!s&&!a)throw new g("No content is provided for sending chat message.");return s?t:n}(t)}function L(e){let t;return t=e.contents?e:{contents:[H(e)]},e.systemInstruction&&(t.systemInstruction=x(e.systemInstruction)),t}const F=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],j={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]},$="SILENT_ERROR";class k{constructor(e,t,n,a={}){this.model=t,this.params=n,this._requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(function(e){let t=!1;for(const n of e){const{role:e,parts:a}=n;if(!t&&"user"!==e)throw new g(`First content should be with role 'user', got ${e}`);if(!s.includes(e))throw new g(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(s)}`);if(!Array.isArray(a))throw new g("Content should have 'parts' property with an array of Parts");if(0===a.length)throw new g("Each Content should have at least one part");const o={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const e of a)for(const t of F)t in e&&(o[t]+=1);const i=j[e];for(const t of F)if(!i.includes(t)&&o[t]>0)throw new g(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,s,a,o,i,r;await this._sendPromise;const c=H(e),l={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(s=this.params)||void 0===s?void 0:s.generationConfig,tools:null===(a=this.params)||void 0===a?void 0:a.tools,toolConfig:null===(o=this.params)||void 0===o?void 0:o.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(r=this.params)||void 0===r?void 0:r.cachedContent,contents:[...this._history,c]},d=Object.assign(Object.assign({},this._requestOptions),t);let u;return this._sendPromise=this._sendPromise.then(()=>M(this._apiKey,this.model,l,d)).then(e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(c);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{const t=v(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}u=e}),await this._sendPromise,u}async sendMessageStream(e,t={}){var n,s,a,o,i,r;await this._sendPromise;const c=H(e),l={safetySettings:null===(n=this.params)||void 0===n?void 0:n.safetySettings,generationConfig:null===(s=this.params)||void 0===s?void 0:s.generationConfig,tools:null===(a=this.params)||void 0===a?void 0:a.tools,toolConfig:null===(o=this.params)||void 0===o?void 0:o.toolConfig,systemInstruction:null===(i=this.params)||void 0===i?void 0:i.systemInstruction,cachedContent:null===(r=this.params)||void 0===r?void 0:r.cachedContent,contents:[...this._history,c]},d=Object.assign(Object.assign({},this._requestOptions),t),u=D(this._apiKey,this.model,l,d);return this._sendPromise=this._sendPromise.then(()=>u).catch(e=>{throw new Error($)}).then(e=>e.response).then(e=>{if(e.candidates&&e.candidates.length>0){this._history.push(c);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=v(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==$&&console.error(e)}),u}}class U{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=x(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;const s=L(e),a=Object.assign(Object.assign({},this._requestOptions),t);return M(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},s),a)}async generateContentStream(e,t={}){var n;const s=L(e),a=Object.assign(Object.assign({},this._requestOptions),t);return D(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(n=this.cachedContent)||void 0===n?void 0:n.name},s),a)}startChat(e){var t;return new k(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null===(t=this.cachedContent)||void 0===t?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){const n=function(e,t){var n;let s={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null===(n=null==t?void 0:t.cachedContent)||void 0===n?void 0:n.name,contents:[]};const a=null!=e.generateContentRequest;if(e.contents){if(a)throw new m("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=e.contents}else if(a)s=Object.assign(Object.assign({},s),e.generateContentRequest);else{const t=H(e);s.contents=[t]}return{generateContentRequest:s}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,s){return(await b(t,h.COUNT_TOKENS,e,!1,JSON.stringify(n),s)).json()}(this.apiKey,this.model,n,s)}async embedContent(e,t={}){const n="string"==typeof(a=e)||Array.isArray(a)?{content:H(a)}:a,s=Object.assign(Object.assign({},this._requestOptions),t);var a;return async function(e,t,n,s){return(await b(t,h.EMBED_CONTENT,e,!1,JSON.stringify(n),s)).json()}(this.apiKey,this.model,n,s)}async batchEmbedContents(e,t={}){const n=Object.assign(Object.assign({},this._requestOptions),t);return async function(e,t,n,s){const a=n.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await b(t,h.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:a}),s)).json()}(this.apiKey,this.model,e,n)}}class P{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new g("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new U(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new m("Cached content must contain a `name` field.");if(!e.model)throw new m("Cached content must contain a `model` field.");const s=["model","systemInstruction"];for(const n of s)if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new m(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}const a=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new U(this.apiKey,a,n)}}const G="seereal_article_history",Y=new class{constructor(){this.genAI=null}async getApiKey(){try{const e=(await chrome.storage.local.get("geminiApiKey")).geminiApiKey;if(e&&"string"==typeof e)return e;const t="AIzaSyCQ94i5yKbl6D78_FW01egooB8bvw7YkSI";return t?.trim()||null}catch{return null}}async analyze(e){const t='Analyze this article and return metrics people care about. Return ONLY valid JSON with these exact keys (no markdown, no code blocks):\n{\n  "left_right": number (-100 = far left, 0 = center, 100 = far right),\n  "auth_lib": number (-100 = authoritarian, 0 = balanced, 100 = libertarian),\n  "nat_glob": number (-100 = nationalist, 0 = balanced, 100 = globalist),\n  "objectivity": number (0 = very opinionated, 100 = very factual and neutral),\n  "sensationalism": number (0 = dry/restrained, 100 = highly sensational/clickbait),\n  "clarity": number (0 = confusing or opaque, 100 = very clear and well-structured),\n  "tone_calm_urgent": number (-100 = very calm/measured, 100 = very urgent/alarming),\n  "confidence": number (0-100, how confident you are in this analysis),\n  "reasoning": string (single, comprehensive paragraph; 3-5 sentences),\n  "highlights": string[] (3-5 verbatim quotes or key phrases from the article that support the analysis)\n}\n\nArticle text:\n'+e.slice(0,15e3),n=await this.getApiKey();if(!n)return this.getFallbackResult();this.genAI=new P(n);const s=["gemini-2.5-flash","gemini-2.0-flash","gemini-2.5-flash-lite"];let a;for(const e of s)try{const n=this.genAI.getGenerativeModel({model:e}),s=(await n.generateContent(t)).response.text(),a=s.match(/\{[\s\S]*\}/),o=a?a[0]:s,i=JSON.parse(o);return{left_right:this.clamp(i.left_right??0,-100,100),auth_lib:this.clamp(i.auth_lib??0,-100,100),nat_glob:this.clamp(i.nat_glob??0,-100,100),objectivity:this.clamp(i.objectivity??50,0,100),sensationalism:this.clamp(i.sensationalism??50,0,100),clarity:this.clamp(i.clarity??50,0,100),tone_calm_urgent:this.clamp(i.tone_calm_urgent??0,-100,100),confidence:this.clamp(i.confidence??50,0,100),reasoning:String(i.reasoning??"Analysis unavailable"),highlights:Array.isArray(i.highlights)?i.highlights.map(String):[]}}catch(e){if(a=e,e?.message?.includes("API key not valid"))break}return console.error("[SeeReal] Bias analysis error:",a),this.getFallbackResult()}clamp(e,t,n){return Math.max(t,Math.min(n,Number(e)||0))}getFallbackResult(){return{left_right:0,auth_lib:0,nat_glob:0,objectivity:50,sensationalism:50,clarity:50,tone_calm_urgent:0,confidence:0,reasoning:"AI analysis unavailable. Add GEMINI_API_KEY to enable.",highlights:[]}}},K=new class{async saveAnalysis(e){try{const t=await this.getStorageData();t.articles[e.url]=e,await this.setStorageData(t)}catch(e){throw console.error("[SeeReal Storage] Failed to save analysis:",e),e}}async getAnalysis(e){try{return(await this.getStorageData()).articles[e]||null}catch(e){return console.error("[SeeReal Storage] Failed to get analysis:",e),null}}async getAllAnalyses(){try{const e=await this.getStorageData();return Object.values(e.articles).sort((e,t)=>t.timestamp-e.timestamp)}catch(e){return console.error("[SeeReal Storage] Failed to get all analyses:",e),[]}}async getAllMetadata(){try{return(await this.getAllAnalyses()).map(e=>({url:e.url,title:e.title,author:e.author,source:e.source,timestamp:e.timestamp,leftRight:e.bias.left_right,objectivity:e.bias.objectivity,confidence:e.bias.confidence}))}catch(e){return console.error("[SeeReal Storage] Failed to get metadata:",e),[]}}async deleteAnalysis(e){try{const t=await this.getStorageData();delete t.articles[e],await this.setStorageData(t)}catch(e){throw console.error("[SeeReal Storage] Failed to delete analysis:",e),e}}async clearAllAnalyses(){try{const e=await this.getStorageData();e.articles={},await this.setStorageData(e)}catch(e){throw console.error("[SeeReal Storage] Failed to clear analyses:",e),e}}async saveDebateRecord(e){try{const t=await this.getStorageData();t.debateHistory.unshift(e),t.debateHistory.length>50&&(t.debateHistory=t.debateHistory.slice(0,50)),await this.setStorageData(t)}catch(e){throw console.error("[SeeReal Storage] Failed to save debate record:",e),e}}async getDebateHistory(){try{return(await this.getStorageData()).debateHistory||[]}catch(e){return console.error("[SeeReal Storage] Failed to get debate history:",e),[]}}async deleteDebateRecord(e){try{const t=await this.getStorageData();t.debateHistory=t.debateHistory.filter(t=>t.id!==e),await this.setStorageData(t)}catch(e){throw console.error("[SeeReal Storage] Failed to delete debate record:",e),e}}async clearOldAnalyses(){try{const e=await this.getStorageData(),t=Date.now()-2592e6;let n=0;for(const[s,a]of Object.entries(e.articles))a.timestamp<t&&(delete e.articles[s],n++);return n>0&&await this.setStorageData(e),n}catch(e){return console.error("[SeeReal Storage] Failed to clear old analyses:",e),0}}async getStats(){try{const e=await this.getStorageData(),t=Object.values(e.articles),n=[...t.map(e=>e.timestamp),...e.debateHistory.map(e=>e.timestamp)];return{count:t.length,oldestTimestamp:n.length>0?Math.min(...n):null,newestTimestamp:n.length>0?Math.max(...n):null,estimatedSizeBytes:JSON.stringify(e).length,debateCount:e.debateHistory.length}}catch(e){return console.error("[SeeReal Storage] Failed to get stats:",e),{count:0,oldestTimestamp:null,newestTimestamp:null,estimatedSizeBytes:0,debateCount:0}}}async getStorageData(){const e=(await chrome.storage.local.get(G))[G];return e&&1===e.version?(e.debateHistory||(e.debateHistory=[]),e):{articles:{},debateHistory:[],version:1}}async setStorageData(e){await chrome.storage.local.set({[G]:e})}},B=new class{async analyzeArticle(e){const{text:t,url:n="unknown",title:s="Untitled Article",author:a,source:o}=e,i=await K.getAnalysis(n);if(i&&Date.now()-i.timestamp<864e5)return{bias:i.bias,cached:!0,timestamp:i.timestamp};const r=await Y.analyze(t),c=Date.now(),l={bias:r,cached:!1,timestamp:c},d={url:n,title:s,author:a,source:o,bias:r,timestamp:c,cached:!1};return await K.saveAnalysis(d),K.clearOldAnalyses().catch(e=>{console.warn("[SeeReal] Failed to clear old analyses:",e)}),l}async getCachedAnalysis(e){const t=await K.getAnalysis(e);return t?{bias:t.bias,cached:!0,timestamp:t.timestamp}:null}async getArticleHistory(){return K.getAllAnalyses()}async deleteArticle(e){return K.deleteAnalysis(e)}async clearHistory(){return K.clearAllAnalyses()}async getDebateHistory(){return K.getDebateHistory()}async deleteDebateRecord(e){return K.deleteDebateRecord(e)}async fetchAuthorInfo(e){const{authorName:t}=e,n=await Y.getApiKey();if(!n)throw new Error("No API key. Add your Gemini API key in the extension popup.");try{const e=new P(n),s=["gemini-2.0-flash","gemini-1.5-flash"];let a,o="";const i=`Search for information about the journalist/author "${t}". Provide:\n1. A brief biography (2-3 sentences)\n2. Their occupation/role\n3. Age (if publicly available)\n4. List of 3-5 notable articles they've written (with titles and URLs if available)\n5. Any social media or professional profile links (LinkedIn, Twitter, etc.)\n6. A URL to a publicly available profile picture of the author (if found)\n\nFormat your response as a JSON object with this structure:\n{\n  "name": "${t}",\n  "bio": "brief biography",\n  "occupation": "their role/title",\n  "age": "age if available, otherwise null",\n  "articles": [\n    {"title": "article title", "url": "article url", "source": "publication", "date": "publication date"}\n  ],\n  "socialLinks": [\n    {"platform": "platform name", "url": "profile url"}\n  ],\n  "imageUrl": "url to author image or null"\n}\n\nIf you cannot find specific information, use null for that field. Only include verified, publicly available information. Return only valid JSON.`;for(const t of s)try{const n=e.getGenerativeModel({model:t,generationConfig:{responseMimeType:"application/json"}});if(o=(await n.generateContent(i)).response.text(),o)break}catch(e){a=e,console.warn(`[SeeReal] Failed to fetch author info with ${t}:`,e)}if(!o)throw a||new Error("All models failed to respond");let r=o.trim();return r.startsWith("```json")?r=r.replace(/^```json\s*/,"").replace(/\s*```$/,""):r.startsWith("```")&&(r=r.replace(/^```\s*/,"").replace(/\s*```$/,"")),{authorInfo:JSON.parse(r)}}catch(e){throw console.error("[SeeReal] Error fetching author info:",e),new Error("Failed to fetch author information. Please try again.")}}async fetchRelatedArticles(e){const{title:t,source:n}=e,s=await Y.getApiKey();if(!s)throw new Error("No API key. Add your Gemini API key in the extension popup.");try{const e=new P(s).getGenerativeModel({model:"gemini-2.0-flash",generationConfig:{responseMimeType:"application/json"}}),a=`Find 3-5 real, recent news articles that cover the same topic as this article: "${t}"${n?` from ${n}`:""}.\nTry to find articles from different sources with varying political perspectives if possible.\n\nReturn a JSON object with this structure:\n{\n  "articles": [\n    {\n      "title": "Article Title",\n      "url": "Article URL",\n      "source": "News Source Name",\n      "date": "Publication Date (approximate is fine)"\n    }\n  ]\n}\n\nReturn ONLY valid JSON. If you cannot find specific articles, return an empty array.`;let o=(await e.generateContent(a)).response.text().trim();return o.startsWith("```json")?o=o.replace(/^```json\s*/,"").replace(/\s*```$/,""):o.startsWith("```")&&(o=o.replace(/^```\s*/,"").replace(/\s*```$/,"")),{relatedArticles:JSON.parse(o).articles||[]}}catch(e){return console.error("[SeeReal] Error fetching related articles:",e),{relatedArticles:[]}}}async generateDebateCards(e){const{text:t,purpose:n,title:s,author:a,source:o,date:i}=e,r=await Y.getApiKey();if(!r)throw new Error("No API key. Add your Gemini API key in the extension popup.");try{const c=new P(r),l=["gemini-2.0-flash","gemini-1.5-flash"];let d,u="";const h=`Act as a competitive policy debate researcher. Generate 2-4 "debate cards" from the following article text that support the following purpose: "${n}".\n\nFormat Requirements for each card:\n1. **Tag**: A single sentence summarizing the argument made by the evidence. Must be punchy and strategic.\n2. **Cite**: Use the author "${a||"Unknown"}", the date "${i||"n.d."}", and source "${o||"Unknown"}". Format as "Author, Date (Source)".\n3. **Body**: This MUST be a continuous, EXACT, VERBATIM segment (at least one full paragraph) from the article. DO NOT change a single character, punctuation, or capitalization.\n4. **Highlights**: Identify specific phrases or full clauses within the Body that should be emphasized. **CRITICAL**: In high-level debate, highlights must form a coherent, condensed version of the argument that can be spoken aloud. Highlight long, readable phrases and complete sentences rather than isolated single words. Reading ONLY the highlighted words should sound like a natural, persuasive speech.\n\n**CRITICAL**: The "body" will be compared against the original article text for validation. If it is not exact, the card will be rejected.\n\nArticle Title: ${s}\nArticle Text: ${t.slice(0,15e3)}\n\nReturn a JSON object with this structure:\n{\n  "cards": [\n    {\n      "tag": "Short summary",\n      "cite": "Author, Date (Source)",\n      "body": "Exact text from article",\n      "highlights": ["word1", "phrase two", "word3"]\n    }\n  ]\n}\n\nOnly use text from the article. Ensure "body" is an exact match for a segment of the article. Return ONLY valid JSON.`;for(const e of l)try{const t=c.getGenerativeModel({model:e,generationConfig:{responseMimeType:"application/json"}});if(u=(await t.generateContent(h)).response.text(),u)break}catch(t){d=t,console.warn(`[SeeReal] Debate card generation failed with ${e}:`,t)}if(!u)throw d||new Error("All models failed to respond");let g=u.trim();g.startsWith("```json")?g=g.replace(/^```json\s*/,"").replace(/\s*```$/,""):g.startsWith("```")&&(g=g.replace(/^```\s*/,"").replace(/\s*```$/,""));const f=JSON.parse(g).cards||[];if(f.length>0){const t={id:Math.random().toString(36).substring(2,15),url:e.url||"unknown",articleTitle:s,purpose:n,cards:f,timestamp:Date.now()};K.saveDebateRecord(t).catch(e=>{console.warn("[SeeReal] Failed to save debate record:",e)})}return{cards:f}}catch(e){throw console.error("[SeeReal] Error generating debate cards:",e),new Error("Failed to generate debate cards. Please check your API key and try again.")}}};chrome.runtime.onInstalled.addListener(()=>{console.log("[SeeReal] Extension installed")}),chrome.runtime.onMessage.addListener((e,t,n)=>(async function(e){switch(e.type){case"ANALYZE_ARTICLE":return B.analyzeArticle(e.payload);case"GET_CACHED_ANALYSIS":return B.getCachedAnalysis(e.payload);case"GET_ARTICLE_HISTORY":return B.getArticleHistory();case"DELETE_ARTICLE":return await B.deleteArticle(e.payload),{success:!0};case"CLEAR_HISTORY":return await B.clearHistory(),{success:!0};case"FETCH_AUTHOR_INFO":return B.fetchAuthorInfo(e.payload);case"FETCH_RELATED_ARTICLES":return B.fetchRelatedArticles(e.payload);case"GENERATE_DEBATE_CARDS":return B.generateDebateCards(e.payload);case"GET_DEBATE_HISTORY":return B.getDebateHistory();case"DELETE_DEBATE_RECORD":return await B.deleteDebateRecord(e.payload),{success:!0};default:throw new Error(`Unknown message type: ${e.type}`)}}(e).then(n).catch(e=>{console.error("[SeeReal] Message handler error:",e),n({error:String(e)})}),!0))})();